<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Letreiro V5 - Music Mode</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            overflow: hidden;
            display: flex;
            align-items: center;
            height: 100vh;
            font-family: 'Courier New', Courier, monospace;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 99;
        }

        /* Player do YouTube invisível */
        #player {
            position: absolute;
            top: -9999px;
            left: -9999px;
        }

        /* Tela de Bloqueio para liberar o Áudio */
        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 99999;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #0f0;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            flex-direction: column;
            text-align: center;
        }

        .marquee-container {
            white-space: nowrap;
            overflow: hidden;
            position: absolute;
            width: 100%;
        }

        .marquee-text {
            display: inline-block;
            font-size: 25vw;
            font-weight: bold;
            color: #0f0;
            text-shadow: 0 0 10px #0f0;
            padding-left: 100%;
            animation: scroll-left 15s linear infinite;
            transform: translate3d(0, 0, 0);
        }

        @keyframes scroll-left {
            0% {
                transform: translate3d(0, 0, 0);
            }

            100% {
                transform: translate3d(-100%, 0, 0);
            }
        }
    </style>
</head>

<body>
    <div id="overlay" onclick="iniciarSistema()">
        <div>TOQUE PARA INICIAR<br><span style="font-size:12px; color:#666">(Necessário para liberar o áudio)</span>
        </div>
    </div>

    <div id="player"></div>

    <div class="marquee-container">
        <div class="marquee-text" id="texto">
            CARREGANDO...
        </div>
    </div>

    <script>
        // --- CONFIGURAÇÃO ---
        var BUCKET_ID = "Nx4eX6XbVusH98XQ86tkpg";
        var KEY = "mensagem";
        var URL_BASE = "https://kvdb.io/" + BUCKET_ID + "/" + KEY;
        var MUSIC_ID = "DOWyEY-VfIw"; // ID do vídeo do YouTube

        var textoAtual = "";
        var velocidadeAtual = "";
        var player; // Variável do YouTube
        var audioLiberado = false;
        var musicaTocando = false;

        // --- YOUTUBE API ---
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '1', width: '1',
                videoId: MUSIC_ID,
                playerVars: { 'playsinline': 1, 'controls': 0, 'loop': 1 }
            });
        }

        // Função chamada ao clicar na tela preta inicial
        function iniciarSistema() {
            document.getElementById('overlay').style.display = 'none';
            audioLiberado = true;
            // Tenta dar um play mudo só para "aquecer" o motor de áudio do Android
            if (player && player.playVideo) {
                player.mute();
                player.playVideo();
                setTimeout(function () { player.pauseVideo(); player.unMute(); }, 500);
            }
            verificarDados(); // Já busca o texto imediatamente
        }

        function dispararConfete() {
            if (typeof confetti === 'undefined') return;
            var duration = 3 * 1000;
            var end = Date.now() + duration;
            (function frame() {
                confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 }, colors: ['#f00', '#0f0', '#00f'] });
                confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 }, colors: ['#f00', '#0f0', '#00f'] });
                if (Date.now() < end) requestAnimationFrame(frame);
            }());
        }

        function verificarDados() {
            var urlComCacheBuster = URL_BASE + "?t=" + new Date().getTime();

            fetch(urlComCacheBuster)
                .then(function (r) { return r.text(); })
                .then(function (dadosRaw) {
                    var dados;
                    try { dados = JSON.parse(dadosRaw); }
                    catch (e) { dados = { texto: dadosRaw, velocidade: 15 }; }

                    // ATUALIZAÇÃO DO TEXTO
                    if (dados.texto && dados.texto !== textoAtual) {
                        textoAtual = dados.texto;
                        document.getElementById('texto').innerText = textoAtual;

                        var t = textoAtual.toLowerCase().trim();

                        // --- LÓGICA DO GATILHO (CONFETE + MÚSICA) ---
                        if (t === "te amo" || t === "teamo") {
                            // Se caiu aqui, solta confete
                            dispararConfete();

                            // E toca música (se já não estiver tocando)
                            if (audioLiberado && player && player.playVideo && !musicaTocando) {
                                console.log("Tocando música...");
                                player.seekTo(0); // Volta pro início
                                player.setVolume(100);
                                player.playVideo();
                                musicaTocando = true;
                            }
                        } else {
                            // Se o texto NÃO for "te amo", PARA a música imediatamente
                            if (musicaTocando && player && player.pauseVideo) {
                                console.log("Parando música...");
                                player.pauseVideo();
                                musicaTocando = false;
                            }
                        }
                    }

                    // ATUALIZAÇÃO DA VELOCIDADE
                    if (dados.velocidade && String(dados.velocidade) !== String(velocidadeAtual)) {
                        velocidadeAtual = dados.velocidade;
                        document.getElementById('texto').style.animationDuration = velocidadeAtual + 's';
                    }
                })
                .catch(function (e) { console.log("Erro: " + e); });
        }

        setInterval(verificarDados, 5000);
    </script>
</body>

</html>