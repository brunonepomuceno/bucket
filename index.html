<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Letreiro V3 - Party Mode</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            overflow: hidden;
            display: flex;
            align-items: center;
            height: 100vh;
            font-family: 'Courier New', Courier, monospace;
        }

        /* O canvas do confete fica por cima de tudo */
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 99;
        }

        .marquee-container {
            white-space: nowrap;
            overflow: hidden;
            position: absolute;
            width: 100%;
        }

        .marquee-text {
            display: inline-block;
            font-size: 25vw;
            font-weight: bold;
            color: #0f0;
            text-shadow: 0 0 10px #0f0;
            padding-left: 100%;
            animation: scroll-left 15s linear infinite;
            transform: translate3d(0, 0, 0);
        }

        @keyframes scroll-left {
            0% {
                transform: translate3d(0, 0, 0);
            }

            100% {
                transform: translate3d(-100%, 0, 0);
            }
        }

        #debug-console {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(50, 0, 0, 0.8);
            color: #fff;
            font-size: 14px;
            z-index: 9999;
            display: none;
            padding: 10px;
        }
    </style>
</head>

<body>
    <div id="debug-console"></div>

    <div class="marquee-container">
        <div class="marquee-text" id="texto">
            INICIANDO...
        </div>
    </div>

    <script>
        // --- CONFIGURAÇÃO ---
        var BUCKET_ID = "Nx4eX6XbVusH98XQ86tkpg";
        var KEY = "mensagem";
        var URL_BASE = "https://kvdb.io/" + BUCKET_ID + "/" + KEY;

        var textoAtual = "";
        var velocidadeAtual = "";
        // Frase gatilho (sempre em minúsculo aqui para facilitar a comparação)
        var GATILHO_CONFETE = "te amo julia";

        function logError(msg) {
            var debugEl = document.getElementById('debug-console');
            debugEl.style.display = 'block';
            debugEl.innerHTML += "ERRO: " + msg + "<br>";
        }
        window.onerror = function (message) { logError(message); };

        // --- FUNÇÃO QUE SOLTA OS CONFETES ---
        function dispararConfete() {
            // Verifica se a biblioteca carregou antes de tentar usar
            if (typeof confetti === 'undefined') { console.log("Lib confete não carregou"); return; }

            var duration = 3 * 1000; // Duração da animação: 3 segundos
            var end = Date.now() + duration;

            // Lança confetes dos dois lados da tela
            (function frame() {
                confetti({
                    particleCount: 5,
                    angle: 60,
                    spread: 55,
                    origin: { x: 0 },
                    colors: ['#ff0000', '#00ff00', '#0000ff', '#ffff00'] // Cores festivas
                });
                confetti({
                    particleCount: 5,
                    angle: 120,
                    spread: 55,
                    origin: { x: 1 },
                    colors: ['#ff0000', '#00ff00', '#0000ff', '#ffff00']
                });

                if (Date.now() < end) {
                    requestAnimationFrame(frame);
                }
            }());
        }

        function verificarDados() {
            var urlComCacheBuster = URL_BASE + "?t=" + new Date().getTime();

            fetch(urlComCacheBuster)
                .then(function (response) { return response.text(); })
                .then(function (dadosRaw) {
                    var dados;
                    try { dados = JSON.parse(dadosRaw); }
                    catch (e) { dados = { texto: dadosRaw, velocidade: 15 }; }

                    // 1. Atualiza o Texto se mudou
                    if (dados.texto && dados.texto !== textoAtual) {
                        textoAtual = dados.texto;
                        document.getElementById('texto').innerText = textoAtual;

                        // --- VERIFICAÇÃO DO GATILHO ---
                        // Converte o texto que chegou para minúsculo e remove espaços extras
                        var textoLimpo = textoAtual.toLowerCase().trim();

                        if (textoLimpo === GATILHO_CONFETE) {
                            console.log("Gatilho acionado! BOOM!");
                            dispararConfete();
                        }
                        // ------------------------------
                    }

                    // 2. Atualiza a Velocidade se mudou
                    if (dados.velocidade && String(dados.velocidade) !== String(velocidadeAtual)) {
                        velocidadeAtual = dados.velocidade;
                        var el = document.getElementById('texto');
                        el.style.animationDuration = velocidadeAtual + 's';
                    }
                })
                .catch(function (error) { console.log("Erro silencioso rede"); });
        }

        try {
            verificarDados();
            setInterval(verificarDados, 5000);
        } catch (e) { logError("Falha crítica: " + e.message); }
    </script>
</body>

</html>